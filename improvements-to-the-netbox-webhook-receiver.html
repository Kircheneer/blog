
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://blog.kirchne.red/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://blog.kirchne.red/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="https://blog.kirchne.red/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://blog.kirchne.red/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://blog.kirchne.red/theme/font-awesome/css/solid.css">


    <link href="https://blog.kirchne.red/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Kirchnered Networking Atom">


    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-183762699-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333">

<meta name="author" content="kirchnerl" />
<meta name="description" content="You can find the the code used in this post here. If you just need a webhook receiver for Netbox follow the instructions in the README.md file in that repository. This is a follow-up to my earlier blog post Netbox webhook receiver with Python, Celery and FastAPI. Here we …" />
<meta name="keywords" content="Celery, FastAPI, Netbox, Python">


<meta property="og:site_name" content="Kirchnered Networking"/>
<meta property="og:title" content="Improvements to the Netbox webhook receiver"/>
<meta property="og:description" content="You can find the the code used in this post here. If you just need a webhook receiver for Netbox follow the instructions in the README.md file in that repository. This is a follow-up to my earlier blog post Netbox webhook receiver with Python, Celery and FastAPI. Here we …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://blog.kirchne.red/improvements-to-the-netbox-webhook-receiver.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-12-19 12:36:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://blog.kirchne.red/author/kirchnerl.html">
<meta property="article:section" content="Programming"/>
<meta property="article:tag" content="Celery"/>
<meta property="article:tag" content="FastAPI"/>
<meta property="article:tag" content="Netbox"/>
<meta property="article:tag" content="Python"/>
<meta property="og:image" content="/images/profile.png">

  <title>Kirchnered Networking &ndash; Improvements to the Netbox webhook receiver</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://blog.kirchne.red">
        <img src="/images/profile.png" alt="Kirchnered Networking" title="Kirchnered Networking">
      </a>

      <h1>
        <a href="https://blog.kirchne.red">Kirchnered Networking</a>
      </h1>

<p>Network Engineer</p>


      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/Kircheneer" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://blog.kirchne.red">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://blog.kirchne.red/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="improvements-to-the-netbox-webhook-receiver">Improvements to the Netbox webhook receiver</h1>
    <p>
      Posted on Sa 19 Dezember 2020 in <a href="https://blog.kirchne.red/category/programming.html">Programming</a>

    </p>
  </header>


  <div>
    <p><em>You can find the the code used in this post <a href="https://github.com/Kircheneer/webhook_receiver/tree/v0.1.0">here</a>.
If you just need a webhook receiver for Netbox follow the instructions in the README.md file in that repository.</em></p>
<p>This is a follow-up to my earlier blog post <a href="https://blog.kirchne.red/programming/netbox-webhook-receiver-with-python-celery-and-fastapi/">Netbox webhook receiver with Python, Celery and FastAPI</a>.
Here we see two major improvements over the previous iteration:</p>
<ul>
<li>Consolidating webhook configuration on the <a href="https://github.com/netbox-community/netbox">Netbox</a>
  side into a single webhook</li>
<li>Implementing a plugin system, which allows users to share their integrations.</li>
</ul>
<h2>Consolidate webhook configuration</h2>
<p>The first implementation of the task registry class from the last blog post looked like this.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TaskRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">Task</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">],</span> <span class="n">Callable</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">action</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">function</span>

        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tasks_to_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">action</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No tasks configured for model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> and action </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tasks_to_run</span><span class="p">]</span>
</code></pre></div>

<p>When receiving a webhook on the <a href="https://fastapi.tiangolo.com/">FastAPI</a> side, you had to call
<code>task_registry.execute(request, 'model', 'action')</code> which is redundant, because the request body already contains the
model and the action. The model and action was also present in the url (e.g. <code>webhooks.example.local/tenant/create</code>),
which required specific webhook configuration on the Netbox side for every model/action combination you wanted to
utilize. Furthermore, this registry is celery-unaware, which meant that all the tasks to be run on the webhook triggers
had to be decorated with both the <code>@celery.task</code> decorator as well as <code>@task_registry.register</code>. The following task
registry implementation solves both of these problems (changes highlighted in bold):</p>
<div class="highlight"><pre><span></span><code> <span class="k">class</span> <span class="nc">TaskRegistry</span><span class="p">:</span>       
    <span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">    Registry for tasks to be executed when model and action conditions are met.        </span>
<span class="sd">    &quot;&quot;&quot;</span>               
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">celery</span><span class="p">:</span> <span class="n">Celery</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">celery</span> <span class="o">=</span> <span class="n">celery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">Task</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>       

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">],</span> <span class="n">Callable</span><span class="p">]:</span>     
        <span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">        Decorator to register tasks in the registry.   </span>
<span class="sd">        :param model: Model to register the task for.    </span>
<span class="sd">        :param event: Event to register the task for.  </span>
<span class="sd">        :return: A decorator adding the decorated function to the registry.      </span>
<span class="sd">        &quot;&quot;&quot;</span>       

        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>      
        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">]:</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>       

         <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span> 
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">function</span><span class="p">))</span>    
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>    
            <span class="k">return</span> <span class="n">function</span>       

        <span class="k">return</span> <span class="n">decorator</span>       

    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>   
        <span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">        Execute tasks in the registry that are assigned to the model and the action.     </span>
<span class="sd">        :param request: The request to pass into the task.       </span>
<span class="sd">        :param model: The model to filter the tasks.      </span>
<span class="sd">        :param action: The action to filters the tasks.   </span>
<span class="sd">        :return: A (possibly empty) list of task results or None if no tasks ran.  </span>
<span class="sd">        &quot;&quot;&quot;</span>       

        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>     
        <span class="k">try</span><span class="p">:</span>       
            <span class="n">tasks_to_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]][</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]]</span>   
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>       
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>    
                <span class="sa">f</span><span class="s2">&quot;No tasks configured for model </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> and action </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>   
            <span class="p">)</span>       
            <span class="k">return</span> <span class="kc">None</span>   
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tasks_to_run</span><span class="p">]</span> 
</code></pre></div>

<h2>Implement plugin functionality</h2>
<p>We now need the following things to achieve the plugin functionality:</p>
<ul>
<li>Register plugin tasks without them knowing of the celery instance</li>
<li>Register plugins with a root registry</li>
<li>Name plugins to allow for useful logging</li>
</ul>
<p>First, we abstract common code from the plugin and the root registry into a base class. Because the plugin registry
will hold callables while the root registry holds celery tasks, we also create a typing generic:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Generic typevar for task registries              </span>
<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span> 

<span class="k">class</span> <span class="nc">_TaskRegistryBase</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>                
    <span class="sd">&quot;&quot;&quot;                 </span>
<span class="sd">    Base class for all plugin and root task registries.                </span>
<span class="sd">    &quot;&quot;&quot;</span>                         
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                 
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">T</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>       

    <span class="k">def</span> <span class="nf">_ensure_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>            
        <span class="sd">&quot;&quot;&quot;            </span>
<span class="sd">        Ensure the necessary dictionary keys are present                       </span>
<span class="sd">        :param model: Model key to be present.                      </span>
<span class="sd">        :param event: Event key to be present.                      </span>
<span class="sd">        &quot;&quot;&quot;</span>       

        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>                       
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>                      
        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">]:</span>                      
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> 
</code></pre></div>

<p>From this base we can inherit the root task registry, which is celery-aware and therefore holds celery tasks:</p>
<div class="highlight"><pre><span></span><code> <span class="k">class</span> <span class="nc">RootTaskRegistry</span><span class="p">(</span><span class="n">_TaskRegistryBase</span><span class="p">[</span><span class="n">Task</span><span class="p">]):</span>              
    <span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">    Registry for tasks to be executed when model and action conditions are met.      </span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>

<p>Note how the class inherits <code>_TaskRegistryBase[Task]</code>, this indicated that the registry holds celery tasks.
The <code>__init__</code>, <code>execute</code> and <code>register</code> methods don't need to be changed for this. Only a new method is added to allow
for the registration of plugin registries. This method iterates over the task registry of the plugin, adds all the
tasks to the root registry and then manually applies the <code>register</code> decorator (which in turn also applies the
<code>celery.task</code> which then turns the functions into tasks that can be run by celery):</p>
<div class="highlight"><pre><span></span><code> <span class="k">def</span> <span class="nf">register_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">:</span> <span class="n">PluginTaskRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>   
        <span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">        Register the tasks a plugin has collected with the root registry.      </span>
<span class="sd">        :param plugin: The plugin.     </span>
<span class="sd">        &quot;&quot;&quot;</span>       
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registering plugin with name </span><span class="si">{</span><span class="n">plugin</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>       
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">events</span> <span class="ow">in</span> <span class="n">plugin</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>   
            <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="n">plugin</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>   
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>       
                    <span class="c1"># Manually apply decorator   </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">event</span><span class="p">)(</span><span class="n">task</span><span class="p">)</span> 
</code></pre></div>

<p>Finally, the plugin registry has to be created. We pass a <code>name</code> parameter to the <code>__init__</code> method in order to
identify the plugin when logging and then create the register decorator. Since the class is unaware of celery, this
only registers the task in the plugin task registry to later be registered with the root registry (as evident by the
<code>Callable</code> in the inherited class).</p>
<div class="highlight"><pre><span></span><code> <span class="k">class</span> <span class="nc">PluginTaskRegistry</span><span class="p">(</span><span class="n">_TaskRegistryBase</span><span class="p">[</span><span class="n">Callable</span><span class="p">]):</span>  
    <span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">    Handles plugin task registration.   </span>

<span class="sd">    Instantiate inside of plugin in order to designate tasks for registration </span>
<span class="sd">    in the task registry.    </span>
<span class="sd">    &quot;&quot;&quot;</span>       

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>   
        <span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">        :param name: Name of the plugin   </span>
<span class="sd">        &quot;&quot;&quot;</span>       

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>    
        <span class="nb">super</span><span class="p">(</span><span class="n">PluginTaskRegistry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>       

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_present</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>       

        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>       
            <span class="k">return</span> <span class="n">function</span>       

        <span class="k">return</span> <span class="n">decorator</span> 
</code></pre></div>

<p>The FastAPI app now has to import plugins dynamically. The idea for this is taken from the Python <a href="https://packaging.python.org/guides/creating-and-discovering-plugins/">documentation</a> itself and is similar to the way its handled by <a href="https://flask.palletsprojects.com">Flask</a>. A <code>plugin_prefix</code> setting is added to the <a href="https://pydantic-docs.helpmanual.io/">Pydantic</a> <a href="https://pydantic-docs.helpmanual.io/usage/settings/">Settings</a> object in order to denote the prefix, plugin modules are then imported as follows. Just like that, all your plugins will run on the correct webhook triggers.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>            
    <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>      
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>    
    <span class="n">digestmod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sha512&quot;</span>    
    <span class="n">plugin_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nbintegrate_&quot;</span>     
    <span class="n">celery_broker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;redis://redis:6379&quot;</span>
    <span class="n">celery_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>       

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="vm">__file__</span><span class="p">)</span>            
<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span> 
<span class="n">celery</span><span class="p">:</span> <span class="n">Celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span>               
    <span class="vm">__file__</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">celery_broker</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">celery_backend</span>       
<span class="p">)</span>                  
<span class="n">registry</span><span class="p">:</span> <span class="n">RootTaskRegistry</span> <span class="o">=</span> <span class="n">RootTaskRegistry</span><span class="p">(</span><span class="n">celery</span><span class="o">=</span><span class="n">celery</span><span class="p">)</span> 

<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="c1"># Discover plugins by name                    </span>
<span class="n">discovered_plugins</span> <span class="o">=</span> <span class="p">{</span>       
    <span class="n">name</span><span class="p">:</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>   
    <span class="k">for</span> <span class="n">finder</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ispkg</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">()</span>   
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">plugin_prefix</span><span class="p">)</span> 
<span class="p">}</span>       

<span class="c1"># Register the plugins in the root registry    </span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">plugin_module</span> <span class="ow">in</span> <span class="n">discovered_plugins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>   
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found plugin </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>    
    <span class="k">try</span><span class="p">:</span>       
        <span class="n">registry</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">plugin_module</span><span class="o">.</span><span class="n">plugin_task_registry</span><span class="p">)</span>     
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>      
            <span class="sa">f</span><span class="s1">&#39;Plugin </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> does not have a member called &quot;plugin_task_registry&quot;. &#39;</span>    
            <span class="s2">&quot;Not loading plugin.&quot;</span>       
        <span class="p">)</span> 
</code></pre></div>

<h2>Example plugin code</h2>
<p>Finally, we want to take a look at an actual plugin. The example task code can be found in the <code>ngintegrate_example</code>
<a href="https://github.com/Kircheneer/webhook_receiver/tree/main/nbintegrate_example">folder</a> in the git repository. Note how
there is now only one decorator on the tasks instead of two, which is much cleaner and less verbose.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>       
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>       

<span class="kn">from</span> <span class="nn">webhook_receiver.task_registry</span> <span class="kn">import</span> <span class="n">PluginTaskRegistry</span>       

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>              
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>       


<span class="c1"># An object with this exact name has to be present in every plugin.       </span>
<span class="c1"># It is automatically imported     </span>
<span class="n">plugin_task_registry</span> <span class="o">=</span> <span class="n">PluginTaskRegistry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Example&quot;</span><span class="p">)</span>       

<span class="nd">@plugin_task_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;tenant&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;created&quot;</span><span class="p">)</span>             
<span class="k">def</span> <span class="nf">example_create_tenant</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>           
    <span class="sd">&quot;&quot;&quot;           </span>
<span class="sd">    Example that fires on /tenant/create.         </span>
<span class="sd">    :param request: The result of the request.json() call on the original request. </span>
<span class="sd">    &quot;&quot;&quot;</span>        
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tenant </span><span class="si">{</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> was created.&quot;</span><span class="p">)</span> 
</code></pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://blog.kirchne.red/tag/celery.html">Celery</a>
      <a href="https://blog.kirchne.red/tag/fastapi.html">FastAPI</a>
      <a href="https://blog.kirchne.red/tag/netbox.html">Netbox</a>
      <a href="https://blog.kirchne.red/tag/python.html">Python</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy; 2021 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Kirchnered Networking ",
  "url" : "https://blog.kirchne.red",
  "image": "/images/profile.png",
  "description": ""
}
</script>


</body>
</html>